{"version":3,"sources":["img-crop.js"],"names":["Crop","el","element","document","querySelector","upload_btn","remove_btn","input","preview","preview_inner","img_el","crop_overlay","createElement","crop_area","top","bottom","left","right","choose_image","dispatchEvent","MouseEvent","view","window","bubbles","cancelable","show_preview","files","reader","FileReader","onload","e","style","display","src","target","result","classList","remove","children","add","readAsDataURL","_update_offset","remove_preview","type","addEventListener","appendChild","cur_side","click_down","index","Array","prototype","indexOf","call","parentElement","click_move","removeEventListener","preventDefault","preview_offset","getBoundingClientRect","setTimeout","_top","Math","round","pageY","clientHeight","_bottom","_left","pageX","clientWidth","_right","_update_overlay","start_drag","contains","drag_crop_area","last_position","deltaX","clientX","x","deltaY","clientY","y","width","height","throttle","callback","limit","wait","apply","bind_events","i","side"],"mappings":";;AAAA,SAASA,IAAT,CAAcC,EAAd,EAAkB;AAAA;AAAA;;AAEd;AACA,SAAKC,OAAL,GAAeC,SAASC,aAAT,CAAuBH,EAAvB,CAAf;;AAEA;AACA,QAAII,aAAa,KAAKH,OAAL,CAAaE,aAAb,CAA2B,aAA3B,CAAjB;AACA,QAAIE,aAAa,KAAKJ,OAAL,CAAaE,aAAb,CAA2B,aAA3B,CAAjB;AACA,QAAIG,QAAQ,KAAKL,OAAL,CAAaE,aAAb,CAA2B,yBAA3B,CAAZ;AACA,QAAII,UAAU,KAAKN,OAAL,CAAaE,aAAb,CAA2B,eAA3B,CAAd;AACA,QAAIK,gBAAgBD,QAAQJ,aAAR,CAAsB,aAAtB,CAApB;AACA,QAAIM,SAASD,cAAcL,aAAd,CAA4B,KAA5B,CAAb;AACA,QAAIO,eAAeR,SAASS,aAAT,CAAuB,KAAvB,CAAnB;;AAEA,SAAKC,SAAL,GAAiB;AACbC,aAAK,EADQ;AAEbC,gBAAQ,EAFK;AAGbC,cAAM,EAHO;AAIbC,eAAO;;AAGX;AAPiB,KAAjB,CAQA,IAAIC,eAAe,SAAfA,YAAe,GAAM;AACrBX,cAAMY,aAAN,CAAoB,IAAIC,UAAJ,CAAe,OAAf,EAAwB;AACxCC,kBAAMC,MADkC;AAExCC,qBAAS,IAF+B;AAGxCC,wBAAY;AAH4B,SAAxB,CAApB;AAKH,KAND;;AAQA;AACA,QAAIC,eAAe,SAAfA,YAAe,GAAM;AACrB,YAAIlB,MAAMmB,KAAN,IAAenB,MAAMmB,KAAN,CAAY,CAAZ,CAAnB,EAAmC;AAC/B,gBAAIC,SAAS,IAAIC,UAAJ,EAAb;AACAD,mBAAOE,MAAP,GAAgB,UAACC,CAAD,EAAO;AACnBpB,uBAAOqB,KAAP,CAAaC,OAAb,GAAuB,OAAvB;AACAtB,uBAAOuB,GAAP,GAAaH,EAAEI,MAAF,CAASC,MAAtB;AACA3B,wBAAQ4B,SAAR,CAAkBC,MAAlB,CAAyB,QAAzB;AACA7B,wBAAQ8B,QAAR,CAAiB,CAAjB,EAAoBF,SAApB,CAA8BG,GAA9B,CAAkC,QAAlC;AACH,aALD;AAMAZ,mBAAOa,aAAP,CAAqBjC,MAAMmB,KAAN,CAAY,CAAZ,CAArB;AACH;AACDe;AACH,KAZD;;AAcA;AACA,QAAIC,iBAAiB,SAAjBA,cAAiB,GAAM;AACvBhC,eAAOqB,KAAP,CAAaC,OAAb,GAAuB,MAAvB;AACAxB,gBAAQ4B,SAAR,CAAkBG,GAAlB,CAAsB,QAAtB;AACA/B,gBAAQ8B,QAAR,CAAiB,CAAjB,EAAoBF,SAApB,CAA8BC,MAA9B,CAAqC,QAArC;AACA9B,cAAM8B,MAAN;AACA9B,gBAAQJ,SAASS,aAAT,CAAuB,OAAvB,CAAR;AACAL,cAAMoC,IAAN,GAAa,MAAb;AACApC,cAAM6B,SAAN,CAAgBG,GAAhB,CAAoB,QAApB;AACAhC,cAAMqC,gBAAN,CAAuB,QAAvB,EAAiCnB,YAAjC,EAA+C,KAA/C;AACA,cAAKvB,OAAL,CAAaE,aAAb,CAA2B,MAA3B,EAAmCyC,WAAnC,CAA+CtC,KAA/C;AACH,KAVD;;AAYA,QAAIuC,QAAJ;AACA,QAAIC,aAAa,SAAbA,UAAa,IAAK;AAClBD,mBAAW;AACP7C,gBAAI6B,EAAEI,MADC;AAEPc,mBAAOC,MAAMC,SAAN,CAAgBC,OAAhB,CAAwBC,IAAxB,CAA6BtB,EAAEI,MAAF,CAASmB,aAAT,CAAuBf,QAApD,EAA8DR,EAAEI,MAAhE,IAA0E;AAF1E,SAAX;AAIAzB,sBAAcmC,gBAAd,CAA+B,WAA/B,EAA4CU,UAA5C,EAAwD,KAAxD;AACAnD,iBAASyC,gBAAT,CAA0B,SAA1B,EAAqC,YAAM;AACvCnC,0BAAc8C,mBAAd,CAAkC,WAAlC,EAA+CD,UAA/C,EAA2D,KAA3D;AACH,SAFD,EAEG,KAFH;AAGAxB,UAAE0B,cAAF;AACA,eAAO,KAAP;AACH,KAXD;;AAaA,QAAIC,cAAJ;AAAA,QACIhB,iBAAiB,SAAjBA,cAAiB,GAAM;AACnBgB,yBAAiBhD,cAAciD,qBAAd,EAAjB;AACH,KAHL;AAIAC,eAAWlB,cAAX,EAA2B,GAA3B;AACA,QAAIa,aAAa,SAAbA,UAAa,IAAK;AAClB,YAAIR,SAASE,KAAT,IAAkB,CAAtB,EAAyB;AACrB;AACA,gBAAIY,OAAOC,KAAKC,KAAL,CAAWhC,EAAEiC,KAAF,GAAUN,eAAe3C,GAApC,CAAX;AACA,gBAAI8C,OAAOnD,cAAcuD,YAAd,GAA6B,MAAKnD,SAAL,CAAeE,MAAnD,IAA6D6C,OAAO,CAAxE,EAA2E;AACvE,sBAAK/C,SAAL,CAAeC,GAAf,GAAqB8C,IAArB;AACH;AACJ,SAND,MAMO,IAAId,SAASE,KAAT,IAAkB,CAAtB,EAAyB;AAC5B;AACA,gBAAIiB,UAAUJ,KAAKC,KAAL,CAAYL,eAAe3C,GAAf,GAAqBL,cAAcuD,YAApC,GAAoDlC,EAAEiC,KAAjE,CAAd;AACA,gBAAIE,UAAUxD,cAAcuD,YAAd,GAA6B,MAAKnD,SAAL,CAAeC,GAAtD,IAA6DmD,UAAU,CAA3E,EAA8E;AAC1E,sBAAKpD,SAAL,CAAeE,MAAf,GAAwBkD,OAAxB;AACH;AACJ,SANM,MAMA,IAAInB,SAASE,KAAT,IAAkB,CAAtB,EAAyB;AAC5B;AACA,gBAAIkB,QAAQL,KAAKC,KAAL,CAAWhC,EAAEqC,KAAF,GAAUV,eAAezC,IAApC,CAAZ;AACA,gBAAIkD,QAAQzD,cAAc2D,WAAd,GAA4B,MAAKvD,SAAL,CAAeI,KAAnD,IAA4DiD,QAAQ,CAAxE,EAA2E;AACvE,sBAAKrD,SAAL,CAAeG,IAAf,GAAsBkD,KAAtB;AACH;AACJ,SANM,MAMA;AACH;AACA,gBAAIG,SAASR,KAAKC,KAAL,CAAYL,eAAezC,IAAf,GAAsBP,cAAc2D,WAArC,GAAoDtC,EAAEqC,KAAjE,CAAb;AACA,gBAAIE,SAAS5D,cAAc2D,WAAd,GAA4B,MAAKvD,SAAL,CAAeG,IAApD,IAA4DqD,SAAS,CAAzE,EAA4E;AACxE,sBAAKxD,SAAL,CAAeI,KAAf,GAAuBoD,MAAvB;AACH;AACJ;AACDC;AACH,KA3BD;;AA6BA,QAAIC,aAAa,SAAbA,UAAa,IAAK;AAClB,YAAIzC,EAAEI,MAAF,CAASE,SAAT,CAAmBoC,QAAnB,CAA4B,MAA5B,CAAJ,EAAyC;AACzC/D,sBAAcmC,gBAAd,CAA+B,WAA/B,EAA4C6B,cAA5C,EAA4D,KAA5D;AACAtE,iBAASyC,gBAAT,CAA0B,SAA1B,EAAqC,YAAM;AACvCnC,0BAAc8C,mBAAd,CAAkC,WAAlC,EAA+CkB,cAA/C,EAA+D,KAA/D;AACAC,4BAAgB,IAAhB;AACH,SAHD,EAGG,KAHH;AAIH,KAPD;;AASA,QAAIA,aAAJ;AACA,QAAID,iBAAiB,SAAjBA,cAAiB,IAAK;AACtB,YAAIC,aAAJ,EAAmB;AACf,gBAAIC,SAAS7C,EAAE8C,OAAF,GAAYF,cAAcG,CAAvC;AAAA,gBACIC,SAAShD,EAAEiD,OAAF,GAAYL,cAAcM,CADvC;AAEA,kBAAKnE,SAAL,CAAeG,IAAf,IAAuB2D,MAAvB;AACA,kBAAK9D,SAAL,CAAeI,KAAf,IAAwB0D,MAAxB;AACA,kBAAK9D,SAAL,CAAeC,GAAf,IAAsBgE,MAAtB;AACA,kBAAKjE,SAAL,CAAeE,MAAf,IAAyB+D,MAAzB;AACAR;AACH;AACDI,wBAAgB;AACZG,eAAG/C,EAAE8C,OADO;AAEZI,eAAGlD,EAAEiD;AAFO,SAAhB;AAIH,KAdD;;AAgBA,QAAIT,kBAAkB,SAAlBA,eAAkB,GAAM;AACxB3D,qBAAaoB,KAAb,CAAmBf,IAAnB,GAA0B,MAAKH,SAAL,CAAeG,IAAf,GAAsB,IAAhD;AACAL,qBAAaoB,KAAb,CAAmBjB,GAAnB,GAAyB,MAAKD,SAAL,CAAeC,GAAf,GAAqB,IAA9C;AACAH,qBAAaoB,KAAb,CAAmBkD,KAAnB,GAA4BxE,cAAc2D,WAAd,GAA4B,MAAKvD,SAAL,CAAeG,IAA3C,GAAkD,MAAKH,SAAL,CAAeI,KAAlE,GAA2E,IAAtG;AACAN,qBAAaoB,KAAb,CAAmBmD,MAAnB,GAA6BzE,cAAcuD,YAAd,GAA6B,MAAKnD,SAAL,CAAeC,GAA5C,GAAkD,MAAKD,SAAL,CAAeE,MAAlE,GAA4E,IAAxG;AACH,KALD;;AAOA;AACA,QAAIoE,WAAW,SAAXA,QAAW,CAACC,QAAD,EAAWC,KAAX,EAAqB;AAChC,YAAIC,OAAO,KAAX;AACA,eAAO,YAAM;AACT,gBAAI,CAACA,IAAL,EAAW;AACPF,yBAASG,KAAT,CAAe,IAAf;AACAD,uBAAO,IAAP;AACA3B,2BAAW,YAAM;AACb2B,2BAAO,KAAP;AACH,iBAFD,EAEGD,KAFH;AAGH;AACJ,SARD;AASH,KAXD;;AAaA;AACA,QAAIG,cAAc,SAAdA,WAAc,GAAM;AACpBnF,mBAAWuC,gBAAX,CAA4B,OAA5B,EAAqC1B,YAArC,EAAmD,KAAnD;AACAZ,mBAAWsC,gBAAX,CAA4B,OAA5B,EAAqCF,cAArC,EAAqD,KAArD;AACAnC,cAAMqC,gBAAN,CAAuB,QAAvB,EAAiCnB,YAAjC,EAA+C,KAA/C;AACAd,qBAAaiC,gBAAb,CAA8B,WAA9B,EAA2C2B,UAA3C,EAAuD,KAAvD;AACAjD,eAAOsB,gBAAP,CAAwB,QAAxB,EAAkCuC,SAAS,YAAM;AAC7C1C;AACA6B;AACAI,4BAAgB,IAAhB;AACH,SAJiC,EAI/B,EAJ+B,CAAlC,EAIQ,KAJR;AAKH,KAVD;;AAcA;AACA,KAAC,YAAM;AACH,aAAK,IAAIe,IAAI,CAAb,EAAgBA,IAAI,CAApB,EAAuBA,GAAvB,EAA4B;AACxB,gBAAIC,OAAOvF,SAASS,aAAT,CAAuB,KAAvB,CAAX;AACA8E,iBAAKtD,SAAL,CAAeG,GAAf,CAAmB,MAAnB;AACAmD,iBAAK9C,gBAAL,CAAsB,WAAtB,EAAmCG,UAAnC,EAA+C,KAA/C;AACApC,yBAAakC,WAAb,CAAyB6C,IAAzB;AACH;AACD/E,qBAAayB,SAAb,CAAuBG,GAAvB,CAA2B,cAA3B;;AAEA9B,sBAAcoC,WAAd,CAA0BlC,YAA1B;AACA,YAAI,CAACD,MAAL,EAAa;AACTA,qBAASP,SAASS,aAAT,CAAuB,KAAvB,CAAT;AACAH,0BAAcoC,WAAd,CAA0BnC,MAA1B;AACH,SAHD,MAGO;AACHA,mBAAOkC,gBAAP,CAAwB,MAAxB,EAAgC0B,eAAhC;AACH;;AAEDkB;AACH,KAlBD;;AAoBA,SAAKtE,YAAL,GAAoBA,YAApB;;AAEA,WAAO,IAAP;AAEH","file":"img-crop.js","sourcesContent":["function Crop(el) {\n\n    /* Get DOM node from selector */\n    this.element = document.querySelector(el)\n\n    /* Get all other elements */\n    let upload_btn = this.element.querySelector('.upload-btn')\n    let remove_btn = this.element.querySelector('.remove-btn')\n    let input = this.element.querySelector('input[type=file].hidden')\n    let preview = this.element.querySelector('.crop-preview')\n    let preview_inner = preview.querySelector('.crop-inner')\n    let img_el = preview_inner.querySelector('img')\n    let crop_overlay = document.createElement('div')\n\n    this.crop_area = {\n        top: 40,\n        bottom: 50,\n        left: 40,\n        right: 400\n    }\n\n    /* Open file browser */\n    let choose_image = () => {\n        input.dispatchEvent(new MouseEvent('click', {\n            view: window,\n            bubbles: true,\n            cancelable: true\n        }))\n    }\n\n    /* SHOW image preview */\n    let show_preview = () => {\n        if (input.files && input.files[0]) {\n            let reader = new FileReader()\n            reader.onload = (e) => {\n                img_el.style.display = 'block'\n                img_el.src = e.target.result\n                preview.classList.remove('no-img')\n                preview.children[0].classList.add('hidden')\n            }\n            reader.readAsDataURL(input.files[0])\n        }\n        _update_offset()\n    }\n\n    /* REMOVE image preview */\n    let remove_preview = () => {\n        img_el.style.display = 'none'\n        preview.classList.add('no-img')\n        preview.children[0].classList.remove('hidden')\n        input.remove()\n        input = document.createElement('input')\n        input.type = 'file'\n        input.classList.add('hidden')\n        input.addEventListener('change', show_preview, false)\n        this.element.querySelector('form').appendChild(input)\n    }\n\n    var cur_side\n    let click_down = e => {\n        cur_side = {\n            el: e.target,\n            index: Array.prototype.indexOf.call(e.target.parentElement.children, e.target) + 1\n        }\n        preview_inner.addEventListener('mousemove', click_move, false)\n        document.addEventListener('mouseup', () => {\n            preview_inner.removeEventListener('mousemove', click_move, false)\n        }, false)\n        e.preventDefault()\n        return false\n    }\n\n    var preview_offset,\n        _update_offset = () => {\n            preview_offset = preview_inner.getBoundingClientRect()\n        }\n    setTimeout(_update_offset, 100);\n    let click_move = e => {\n        if (cur_side.index == 1) {\n            // Top\n            let _top = Math.round(e.pageY - preview_offset.top)\n            if (_top < preview_inner.clientHeight - this.crop_area.bottom && _top > 0) {\n                this.crop_area.top = _top\n            }\n        } else if (cur_side.index == 3) {\n            // Bottom\n            let _bottom = Math.round((preview_offset.top + preview_inner.clientHeight) - e.pageY)\n            if (_bottom < preview_inner.clientHeight - this.crop_area.top && _bottom > 0) {\n                this.crop_area.bottom = _bottom\n            }\n        } else if (cur_side.index == 4) {\n            // Left\n            let _left = Math.round(e.pageX - preview_offset.left)\n            if (_left < preview_inner.clientWidth - this.crop_area.right && _left > 0) {\n                this.crop_area.left = _left\n            }\n        } else {\n            // Right\n            let _right = Math.round((preview_offset.left + preview_inner.clientWidth) - e.pageX)\n            if (_right < preview_inner.clientWidth - this.crop_area.left && _right > 0) {\n                this.crop_area.right = _right\n            }\n        }\n        _update_overlay();\n    }\n\n    let start_drag = e => {\n        if (e.target.classList.contains('side')) return\n        preview_inner.addEventListener('mousemove', drag_crop_area, false)\n        document.addEventListener('mouseup', () => {\n            preview_inner.removeEventListener('mousemove', drag_crop_area, false)\n            last_position = null\n        }, false)\n    }\n\n    var last_position\n    let drag_crop_area = e => {\n        if (last_position) {\n            let deltaX = e.clientX - last_position.x,\n                deltaY = e.clientY - last_position.y\n            this.crop_area.left += deltaX\n            this.crop_area.right -= deltaX\n            this.crop_area.top += deltaY\n            this.crop_area.bottom -= deltaY\n            _update_overlay()\n        }\n        last_position = {\n            x: e.clientX,\n            y: e.clientY\n        }\n    }\n\n    let _update_overlay = () => {\n        crop_overlay.style.left = this.crop_area.left + 'px';\n        crop_overlay.style.top = this.crop_area.top + 'px';\n        crop_overlay.style.width = (preview_inner.clientWidth - this.crop_area.left - this.crop_area.right) + 'px';\n        crop_overlay.style.height = (preview_inner.clientHeight - this.crop_area.top - this.crop_area.bottom) + 'px';\n    }\n\n    /* Limit calls to a function */\n    let throttle = (callback, limit) => {\n        let wait = false\n        return () => {\n            if (!wait) {\n                callback.apply(null, arguments)\n                wait = true\n                setTimeout(() => {\n                    wait = false\n                }, limit)\n            }\n        }\n    }\n\n    /* Bind events */\n    let bind_events = () => {\n        upload_btn.addEventListener('click', choose_image, false)\n        remove_btn.addEventListener('click', remove_preview, false)\n        input.addEventListener('change', show_preview, false)\n        crop_overlay.addEventListener('mousedown', start_drag, false)\n        window.addEventListener('resize', throttle(() => {\n            _update_offset()\n            _update_overlay()\n            last_position = null\n        }, 50), false)\n    }\n\n\n\n    /* Initialise preview */\n    (() => {\n        for (let i = 4; i > 0; i--) {\n            let side = document.createElement('div')\n            side.classList.add('side')\n            side.addEventListener('mousedown', click_down, false)\n            crop_overlay.appendChild(side)\n        }\n        crop_overlay.classList.add('crop-overlay')\n\n        preview_inner.appendChild(crop_overlay)\n        if (!img_el) {\n            img_el = document.createElement('img')\n            preview_inner.appendChild(img_el)\n        } else {\n            img_el.addEventListener('load', _update_overlay)\n        }\n\n        bind_events()\n    })()\n\n    this.choose_image = choose_image\n\n    return this\n\n}\n"]}