{"version":3,"sources":["img-crop.js"],"names":["Crop","options","element","document","querySelector","self","upload_btn","remove_btn","form","input","preview","preview_inner","img_el","crop_overlay","createElement","crop_area","top","bottom","left","right","choose_image","dispatchEvent","MouseEvent","view","window","bubbles","cancelable","show_preview","files","reader","FileReader","onload","e","style","display","src","target","result","classList","remove","children","add","readAsDataURL","_update_offset","remove_preview","type","addEventListener","appendChild","cur_side","click_down","el","index","Array","prototype","indexOf","call","parentElement","click_move","preventDefault","preview_offset","getBoundingClientRect","setTimeout","_top","Math","round","pageY","clientHeight","_bottom","_left","pageX","clientWidth","_right","_update_overlay","last_position","drag_crop_area","deltaX","clientX","x","deltaY","clientY","y","width","height","_update_preview","method","body","JSON","stringify","headers","Headers","fetch","then","response","text","preview_img","base64_preview","throttle","callback","limit","wait","apply","bind_events","contains","removeEventListener","i","side"],"mappings":"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","file":"img-crop.js","sourcesContent":["function Crop(options) {\r\n\r\n    /* Get DOM node from selector */\r\n    this.element = document.querySelector(typeof options == 'object' ? options.element : options)\r\n    var self = this\r\n\r\n    /* Get all other elements */\r\n    let upload_btn = this.element.querySelector('.upload-btn')\r\n    let remove_btn = this.element.querySelector('.remove-btn')\r\n    let form = this.element.querySelector('form')\r\n    let input = form.querySelector('input[type=file].hidden')\r\n    let preview = this.element.querySelector('.crop-preview')\r\n    let preview_inner = preview.querySelector('.crop-inner')\r\n    let img_el = preview_inner.querySelector('img')\r\n    let crop_overlay = document.createElement('div')\r\n\r\n    /* Get preview if set */\r\n    if (options.preview) {\r\n        this.preview = document.querySelector(options.preview)\r\n    }\r\n\r\n    /* Debuggging... */\r\n    this.crop_area = {\r\n        top: 40,\r\n        bottom: 50,\r\n        left: 40,\r\n        right: 400\r\n    }\r\n    /* End debugging... */\r\n\r\n\r\n\r\n    /* Open file browser */\r\n    let choose_image = () => {\r\n        input.dispatchEvent(new MouseEvent('click', {\r\n            view: window,\r\n            bubbles: true,\r\n            cancelable: true\r\n        }))\r\n    }\r\n\r\n    /* SHOW image preview */\r\n    let show_preview = () => {\r\n        if (input.files && input.files[0]) {\r\n            let reader = new FileReader()\r\n            reader.onload = (e) => {\r\n                img_el.style.display = 'block'\r\n                img_el.src = e.target.result\r\n                preview.classList.remove('no-img')\r\n                preview.children[0].classList.add('hidden')\r\n            }\r\n            reader.readAsDataURL(input.files[0])\r\n        }\r\n        _update_offset()\r\n    }\r\n\r\n    /* REMOVE image preview */\r\n    let remove_preview = () => {\r\n        img_el.style.display = 'none'\r\n        preview.classList.add('no-img')\r\n        preview.children[0].classList.remove('hidden')\r\n        input.remove()\r\n        input = document.createElement('input')\r\n        input.type = 'file'\r\n        input.classList.add('hidden')\r\n        input.addEventListener('change', show_preview, false)\r\n        this.element.querySelector('form').appendChild(input)\r\n    }\r\n\r\n    var cur_side\r\n    let click_down = e => {\r\n        cur_side = {\r\n            el: e.target,\r\n            index: Array.prototype.indexOf.call(e.target.parentElement.children, e.target) + 1\r\n        }\r\n        preview_inner.addEventListener('mousemove', click_move, false)\r\n        e.preventDefault()\r\n        return false\r\n    }\r\n\r\n    var preview_offset,\r\n        _update_offset = () => {\r\n            preview_offset = preview_inner.getBoundingClientRect()\r\n        }\r\n    setTimeout(_update_offset, 100)\r\n    function click_move(e) {\r\n        if (cur_side.index == 1) {\r\n            // Top\r\n            let _top = Math.round(e.pageY - preview_offset.top)\r\n            if (_top < preview_inner.clientHeight - this.crop_area.bottom && _top > 0) {\r\n                this.crop_area.top = _top\r\n            }\r\n        } else if (cur_side.index == 3) {\r\n            // Bottom\r\n            let _bottom = Math.round((preview_offset.top + preview_inner.clientHeight) - e.pageY)\r\n            if (_bottom < preview_inner.clientHeight - this.crop_area.top && _bottom > 0) {\r\n                this.crop_area.bottom = _bottom\r\n            }\r\n        } else if (cur_side.index == 4) {\r\n            // Left\r\n            let _left = Math.round(e.pageX - preview_offset.left)\r\n            if (_left < preview_inner.clientWidth - this.crop_area.right && _left > 0) {\r\n                this.crop_area.left = _left\r\n            }\r\n        } else {\r\n            // Right\r\n            let _right = Math.round((preview_offset.left + preview_inner.clientWidth) - e.pageX)\r\n            if (_right < preview_inner.clientWidth - this.crop_area.left && _right > 0) {\r\n                this.crop_area.right = _right\r\n            }\r\n        }\r\n        _update_overlay()\r\n    }\r\n\r\n    var last_position\r\n    function drag_crop_area(e) {\r\n        if (last_position) {\r\n            let deltaX = e.clientX - last_position.x,\r\n                deltaY = e.clientY - last_position.y\r\n            self.crop_area.left += deltaX\r\n            self.crop_area.right -= deltaX\r\n            self.crop_area.top += deltaY\r\n            self.crop_area.bottom -= deltaY\r\n            _update_overlay()\r\n        }\r\n        last_position = {\r\n            x: e.clientX,\r\n            y: e.clientY\r\n        }\r\n    }\r\n\r\n    function _update_overlay() {\r\n        crop_overlay.style.left = self.crop_area.left + 'px'\r\n        crop_overlay.style.top = self.crop_area.top + 'px'\r\n        crop_overlay.style.width = (preview_inner.clientWidth - self.crop_area.left - self.crop_area.right) + 'px'\r\n        crop_overlay.style.height = (preview_inner.clientHeight - self.crop_area.top - self.crop_area.bottom) + 'px'\r\n    }\r\n\r\n    function _update_preview() {\r\n        let options = {\r\n            method: 'POST',\r\n            body: JSON.stringify(self.crop_area),\r\n            headers: new Headers({\r\n                'Content-Type': 'application/json'\r\n            })\r\n        }\r\n        fetch('/preview', options)\r\n            .then(response => {\r\n                return response.text()\r\n            })\r\n            .then(base64_preview => {\r\n                if (!self.preview_img) {\r\n                    self.preview_img = document.createElement('img')\r\n                    self.preview.appendChild(self.preview_img)\r\n                }\r\n                self.preview_img.src = 'data:image/jpeg;base64,' + base64_preview\r\n            })\r\n    }\r\n\r\n    /* Limit calls to a function */\r\n    function throttle(callback, limit) {\r\n        let wait = false\r\n        return () => {\r\n            if (!wait) {\r\n                callback.apply(null, arguments)\r\n                wait = true\r\n                setTimeout(() => {\r\n                    wait = false\r\n                }, limit)\r\n            }\r\n        }\r\n    }\r\n\r\n    /* Bind events */\r\n    function bind_events() {\r\n        upload_btn.addEventListener('click', choose_image, false)\r\n        remove_btn.addEventListener('click', remove_preview, false)\r\n        input.addEventListener('change', show_preview, false)\r\n        crop_overlay.addEventListener('mousedown', (e) => {\r\n            if (e.target.classList.contains('side')) return\r\n            preview_inner.addEventListener('mousemove', drag_crop_area, false)\r\n        }, false)\r\n        document.addEventListener('mouseup', () => {\r\n            last_position = null\r\n            preview_inner.removeEventListener('mousemove', click_move, false)\r\n            preview_inner.removeEventListener('mousemove', drag_crop_area, false)\r\n            _update_preview()\r\n        }, false)\r\n        window.addEventListener('resize', throttle(() => {\r\n            _update_offset()\r\n            _update_overlay()\r\n            last_position = null\r\n        }, 50), false)\r\n    }\r\n\r\n\r\n\r\n    /* Initialise preview */\r\n    (() => {\r\n        for (let i = 4; i > 0; i--) {\r\n            let side = document.createElement('div')\r\n            side.classList.add('side')\r\n            side.addEventListener('mousedown', click_down, false)\r\n            crop_overlay.appendChild(side)\r\n        }\r\n        crop_overlay.classList.add('crop-overlay')\r\n\r\n        preview_inner.appendChild(crop_overlay)\r\n        if (!img_el) {\r\n            img_el = document.createElement('img')\r\n            preview_inner.appendChild(img_el)\r\n        } else {\r\n            img_el.addEventListener('load', _update_overlay)\r\n        }\r\n\r\n        bind_events()\r\n    })()\r\n\r\n    this.choose_image = choose_image\r\n\r\n    return this\r\n\r\n}\r\n"]}